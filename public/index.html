<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mafia Stand-off â€“ Realtime</title>
  <style>
    :root{--bg:#0e1116;--panel:#151a22;--muted:#8fa1b3;--text:#e7edf3;--accent:#5eead4;--accent-2:#7aa2ff;--card:#1c2430;--card-2:#232e3b;--shadow:0 10px 25px rgba(0,0,0,.35);--radius:18px}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 10% -10%,#1a2230 0%,var(--bg) 60%) fixed;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
    a{color:var(--accent)} #app{max-width:1200px;margin:0 auto;padding:16px 16px 24px}
    .btn{border:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg,#1f2836,#151b25);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow);transition:all .14s;font-weight:600}
    .btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.18)}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .btn-primary{background:linear-gradient(180deg,#2a3344,#18202e);border-color:#3b4a63}
    .grid{display:grid;gap:14px}
    .panel{background:linear-gradient(180deg,var(--panel),#0f141b);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .input{background:#0f141b;border:1px solid #2a3b52;border-radius:12px;padding:10px 12px;color:var(--text)}
    .muted{color:var(--muted)} .title{font-weight:800}
    .table{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    .opponent{background:linear-gradient(180deg,var(--panel),#10151c);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);padding:12px;display:flex;flex-direction:column;gap:10px;position:relative;box-shadow:var(--shadow);min-height:132px}
    .who{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .role-pill{font-size:12px;padding:4px 8px;border-radius:999px;background:#1f2937;color:#b7c5d8;border:1px solid rgba(255,255,255,.06)}
    .role-pill.revealed{background:#253044;color:#cfe3ff}
    .status{display:flex;gap:6px;flex-wrap:wrap}
    .badge{font-size:12px;padding:3px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.08);color:#d3deea;background:#1e2633}
    .hearts{display:flex;gap:2px} .heart{font-size:16px;filter:drop-shadow(0 2px 6px rgba(0,0,0,.35))}
    .cards{font-size:13px;color:var(--muted)}
    .dead .overlay{position:absolute;inset:0;border-radius:var(--radius);background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;font-weight:800;color:#ffb4b4;font-size:22px;letter-spacing:1px}
    .center{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .hand{display:flex;flex-wrap:wrap;gap:10px;min-height:90px}
    .card{width:140px;min-height:86px;background:linear-gradient(180deg,var(--card-2),var(--card));border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:8px;display:flex;flex-direction:column;gap:6px;cursor:pointer;position:relative;box-shadow:var(--shadow);transition:transform .12s,border-color .12s}
    .card .ct{font-size:12px;text-transform:uppercase;letter-spacing:.6px;color:#c6d7ee;opacity:.9}
    .card .emoji{font-size:20px}
    .card .text{font-size:12px;color:#b8c5d7}
    .card:hover{transform:translateY(-2px);border-color:#7aa2ff77}
    .card.sel{outline:2px solid var(--accent-2);transform:translateY(-2px)}
    .target{outline:2px dashed #9dd1ff;border-radius:12px}
    .log{padding:12px;max-height:260px;overflow:auto}
    .hud{font-size:12px;color:#9fb4cc}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:40;padding:20px}
    .overlay.show{display:flex}
    .ask-box{background:linear-gradient(180deg,#17202c,#0e141c);border:1px solid #2a3b52;border-radius:16px;padding:16px;max-width:520px;width:100%;box-shadow:var(--shadow)}
    @media (max-width:930px){.table{grid-template-columns:1fr}.center{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div id="app" class="grid">
    <!-- LOBBY -->
    <section class="panel" id="lobbyPanel">
      <div class="title">ğŸ”— Lobby</div>
      <div class="row" style="margin-top:8px">
        <input id="name" class="input" placeholder="VaÅ¡e jmÃ©no" />
        <button id="createBtn" class="btn btn-primary">VytvoÅ™it lobby</button>
        <input id="joinId" class="input" placeholder="KÃ³d lobby (napÅ™. ABCD)" style="width:140px" />
        <button id="joinBtn" class="btn">PÅ™ipojit</button>
      </div>
      <div id="lobbyInfo" class="muted" style="margin-top:10px"></div>
      <div id="players" style="margin-top:8px"></div>
      <div class="row" style="margin-top:8px">
        <button id="readyBtn" class="btn">Jsem pÅ™ipraven</button>
        <button id="startBtn" class="btn btn-primary" disabled>Start hry (host)</button>
      </div>
      <p class="muted" style="margin-top:8px">Hra podporuje 2â€“7 hrÃ¡ÄÅ¯. Don je vÅ¾dy odhalenÃ½.</p>
    </section>

    <!-- BOARD -->
    <section class="panel" id="boardPanel" style="display:none">
      <div class="row" style="justify-content:space-between">
        <div>
          <b>ğŸ•´ï¸ Mafia Stand-off</b> <span class="muted" id="roomTag"></span>
          <div class="hud" id="hud"></div>
          <div class="hud" id="continental"></div>
        </div>
        <div class="row">
          <button id="endTurn" class="btn">â­ï¸ Konec tahu</button>
          <button id="backLobby" class="btn">â† Lobby</button>
        </div>
      </div>

      <div class="center" style="margin-top:10px">
        <div class="panel">
          <div><b>Na tahu:</b> <span id="turnName">â€”</span></div>
          <div class="row" style="margin-top:8px">
            <div>BalÃ­Äek: <b id="deckCount">0</b></div>
            <div>Odhaz.: <b id="discardCount">0</b></div>
          </div>
          <div class="log" id="log"></div>
        </div>

        <div class="panel">
          <div class="title">StÅ¯l</div>
          <div class="table" id="table"></div>
        </div>
      </div>

      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <div><b>ğŸ’¼ VaÅ¡e ruka</b></div>
          <div class="row muted">Å½ivoty: <span id="meHearts" class="hearts" style="margin-left:6px"></span></div>
        </div>
        <div id="hand" class="hand"></div>
      </div>
    </section>
  </div>

  <!-- REACTION MODAL -->
  <div class="overlay" id="ask">
    <div class="ask-box">
      <h3 id="askTitle" style="margin:0 0 8px">Reakce</h3>
      <p id="askBody" class="muted" style="margin:0 0 10px"></p>
      <div class="row">
        <button id="askYes" class="btn btn-primary">ğŸ›¡ï¸ Ãšhyb</button>
        <button id="askNo" class="btn">UtrÅ¾it zÃ¡sah</button>
      </div>
    </div>
  </div>

  <script>
    /* ---------- WS ---------- */
    const ws = new WebSocket((location.protocol==='https:'?'wss://':'ws://')+location.host);
    const send = (obj)=>{ if(ws.readyState!==1){ addLog('â— SpojenÃ­ nenÃ­ pÅ™ipraveno.'); return false; } ws.send(JSON.stringify(obj)); return true; };

    ws.addEventListener('message',(ev)=>{
      const msg = JSON.parse(ev.data);
      if (msg.type==='lobby'){ if(msg.youId) window.__myId = msg.youId; updateLobby(msg.lobby); }
      if (msg.type==='info'){ addLog(msg.message); }
      if (msg.type==='error'){ addLog('â— '+msg.message); }
      if (msg.type==='state'){ applyState(msg.state); }
    });

    /* ---------- LOBBY UI ---------- */
    const lobbyPanel = document.getElementById('lobbyPanel');
    const boardPanel = document.getElementById('boardPanel');
    const nameInp = document.getElementById('name');
    const createBtn = document.getElementById('createBtn');
    const joinIdInp = document.getElementById('joinId');
    const joinBtn = document.getElementById('joinBtn');
    const lobbyInfo = document.getElementById('lobbyInfo');
    const playersDiv = document.getElementById('players');
    const readyBtn = document.getElementById('readyBtn');
    const startBtn = document.getElementById('startBtn');
    const roomTag = document.getElementById('roomTag');

    createBtn.onclick = ()=> send({ type:'create', name: nameInp.value });
    joinBtn.onclick   = ()=> send({ type:'join', lobbyId: joinIdInp.value, name: nameInp.value });
    readyBtn.onclick  = ()=> send({ type:'ready', ready: true });
    startBtn.onclick  = ()=> send({ type:'start' });

    function updateLobby(lobby){
      window.__lobby = lobby;
      lobbyInfo.textContent = lobby ? `KÃ³d lobby: ${lobby.lobbyId}  â€¢  Host: ${short(lobby.hostId)} â€¢ HrÃ¡ÄÅ¯: ${lobby.players.length}` : '';
      playersDiv.innerHTML = lobby.players.map(p=>`â€¢ ${p.name} ${p.id===lobby.hostId?'(host)':''}`).join('<br/>');

      const iAmHost = (myId() && lobby && myId()===lobby.hostId);
      startBtn.disabled = !(iAmHost && lobby.players.length>=2);

      if (lobby.started){
        lobbyPanel.style.display='none';
        boardPanel.style.display='block';
        roomTag.textContent = `Lobby ${lobby.lobbyId}`;
      }
    }

    function myId(){ return window.__myId||null; }
    function short(x){ return x ? x.slice(0,4)+'â€¦' : ''; }

    /* ---------- BOARD UI ---------- */
    const logEl = document.getElementById('log');
    const handEl = document.getElementById('hand');
    const tableEl = document.getElementById('table');
    const meHearts = document.getElementById('meHearts');
    const deckCountEl = document.getElementById('deckCount');
    const discardCountEl = document.getElementById('discardCount');
    const turnNameEl = document.getElementById('turnName');
    const endTurnBtn = document.getElementById('endTurn');
    const backLobbyBtn = document.getElementById('backLobby');
    const hud = document.getElementById('hud');
    const continental = document.getElementById('continental');

    backLobbyBtn.onclick = ()=>{ boardPanel.style.display='none'; lobbyPanel.style.display='block'; };

    let STATE=null, selectedCard=null;

    function addLog(msg){ const p=document.createElement('div'); p.textContent = msg; logEl.appendChild(p); logEl.scrollTop=logEl.scrollHeight; }

    const META={
      // Attacks & reactions
      SHOT:{emoji:'ğŸ”«',name:'VÃ½stÅ™el',desc:'StÅ™el na cÃ­l do dostÅ™elu zbranÄ›. ObrÃ¡nce mÅ¯Å¾e ğŸ›¡ï¸.'},
      DODGE:{emoji:'ğŸ›¡ï¸',name:'Ãšhyb',desc:'Reakce na VÃ½stÅ™el.'},
      KNIFE:{emoji:'ğŸ”ª',name:'NÅ¯Å¾',desc:'ZraÅˆ cÃ­l ve vzdÃ¡lenosti 1.'},
      MOLOTOV:{emoji:'ğŸ¾',name:'Molotov',desc:'ZraÅˆ cÃ­l ve vzdÃ¡lenosti 1.'},
      SHOOTOUT:{emoji:'ğŸ¤œğŸ¤›',name:'PÅ™estÅ™elka',desc:'VÅ¡ichni ostatnÃ­ musÃ­ odhodit ğŸ”« nebo utrÅ¾Ã­ 1.'},
      SPRAY:{emoji:'ğŸŒªï¸',name:'Tommy Gun Spray',desc:'VÅ¡ichni ostatnÃ­ musÃ­ odhodit ğŸ›¡ï¸ nebo utrÅ¾Ã­ 1.'},
      VENDETTA:{emoji:'ğŸ—¡ï¸',name:'Vendeta',desc:'StÅ™Ã­davÄ› odhazujte ğŸ”«; kdo nemÃ¡, utrÅ¾Ã­ 1.'},
      // Heals
      WHISKEY:{emoji:'ğŸ¥ƒ',name:'Whiskey',desc:'+1 Å¾ivot.'},
      CIGAR:{emoji:'ğŸš¬',name:'DoutnÃ­k',desc:'+1 Å¾ivot.'},
      // Control
      PRISON:{emoji:'ğŸš”',name:'VÄ›zenÃ­',desc:'CÃ­l vynechÃ¡ kolo, pokud nehodÃ­ ğŸš” na zaÄÃ¡tku tahu.'},
      EXTORTION:{emoji:'ğŸ’°',name:'VÃ½palnÃ©',desc:'Vem libovolnou kartu z cÃ­le (ruka/vÃ½bava).'},
      RAID:{emoji:'ğŸ”¥',name:'Razie',desc:'Spal cÃ­li nÃ¡hodnou kartu (ruka/vÃ½bava).'},
      // Equipment
      W_SAWED:{emoji:'ğŸ§©',name:'Sawed-off',desc:'ZbraÅˆ: dostÅ™el 2.'},
      W_DOUBLE:{emoji:'ğŸ§©',name:'Double-barrel',desc:'ZbraÅˆ: dostÅ™el 2.'},
      W_COLT:{emoji:'ğŸ§©',name:'Colt 1911',desc:'ZbraÅˆ: dostÅ™el 3.'},
      W_TOMMY:{emoji:'ğŸ§©',name:'Tommy Gun',desc:'ZbraÅˆ: dostÅ™el 3, neomezenÃ© ğŸ”«.'},
      W_WINCH:{emoji:'ğŸ§©',name:'Winchester',desc:'ZbraÅˆ: dostÅ™el 4.'},
      W_SPRING:{emoji:'ğŸ§©',name:'Springfield',desc:'ZbraÅˆ: dostÅ™el 5.'},
      VEST:{emoji:'ğŸ¦º',name:'NeprÅ¯stÅ™elnÃ¡ vesta',desc:'PÅ™i ğŸ”« hoÄ kostkou; na â¤ï¸ ignorujeÅ¡ zÃ¡sah.'},
    };

    function applyState(s){
      STATE = s;
      if (!window.__myId && s.you) window.__myId = s.you.id;

      deckCountEl.textContent = s.deckCount;
      discardCountEl.textContent = s.discardCount;
      turnNameEl.textContent = findName(s.turnPlayerId) || 'â€”';
      continental.textContent = s.roundNote ? `ğŸƒ KontinentÃ¡l: ${s.roundNote}` : '';

      // HUD â€“ ukaÅ¾ role jen pokud jsou odhalenÃ© nebo jsem to jÃ¡
      const myRole = s.you.role ? `â€¢ Moje role: ${s.you.role}` : '';
      hud.textContent = `Na tahu: ${findName(s.turnPlayerId)||'â€”'} ${isMyTurn()?'(JÃ)':''} ${myRole}`;

      // hearts
      meHearts.innerHTML = '';
      for(let i=0;i<s.you.maxHp;i++){
        const span=document.createElement('span'); span.className='heart';
        span.textContent = i<s.you.hp ? 'â¤' : 'ğŸ¤';
        meHearts.appendChild(span);
      }

      // hand
      handEl.innerHTML='';
      (s.you.hand||[]).forEach(card=>{
        const m = META[card.type]||{name:card.type,emoji:'ğŸƒ',desc:''};
        const div=document.createElement('div');
        div.className='card'; div.setAttribute('data-card-id',card.id);
        div.innerHTML=`<div class="ct">${m.name}</div><div class="emoji">${m.emoji}</div><div class="text">${m.desc}</div>`;
        div.onclick = ()=> onPlay(card);
        handEl.appendChild(div);
      });

      // table
      renderOpponents(true);

      // pending reaction â€“ Ãšhyb
      if (s.pending && s.pending.type==='SHOT' && s.pending.askYouToDodge){
        showAsk('Ãšhyb?', 'Byli jste terÄem ğŸ”« VÃ½stÅ™elu. ZahrÃ¡t ğŸ›¡ï¸ Ãšhyb?', ()=>{
          send({ type:'reaction', choice:'DODGE' }); hideAsk();
        }, ()=>{
          send({ type:'reaction', choice:'TAKE_HIT' }); hideAsk();
        });
      } else hideAsk();

      endTurnBtn.disabled = !isMyTurn() || !!s.pending;
    }

    function renderOpponents(resetTargets=false){
      tableEl.innerHTML='';
      (STATE?.others||[]).forEach(op=>{
        const wrap=document.createElement('div');
        wrap.className='opponent'+(op.dead?' dead':'');
        wrap.setAttribute('data-player-id',op.id);
        const roleHTML = `<div class="role-pill ${op.roleRevealed?'revealed':''}">${op.roleRevealed ? (op.role||'â€”') : 'NeznÃ¡mÃ¡'}</div>`;
        const statusHTML = `
          <div class="status">
            ${op.inPrison?'<span class="badge">ğŸš” Ve vÄ›zenÃ­</span>':''}
            ${op.weapon?`<span class="badge">ğŸ”§ ${op.weapon.name}</span>`:''}
            ${op.vest?'<span class="badge">ğŸ¦º Vesta</span>':''}
          </div>`;
        wrap.innerHTML = `
          <div class="who"><div>${op.name}</div>${roleHTML}</div>
          ${statusHTML}
          <div class="hearts">${'â¤'.repeat(op.hp)}${'ğŸ¤'.repeat(Math.max(0, op.maxHp-op.hp))}</div>
          <div class="cards">Karty v ruce: ${op.handCount}</div>
        `;
        tableEl.appendChild(wrap);
      });
      if (resetTargets){
        Array.from(tableEl.querySelectorAll('.opponent')).forEach(n=>{ n.classList.remove('target'); n.onclick=null; });
        selectedCard=null;
      }
    }

    function findName(id){
      if (!STATE) return '';
      if (STATE.you && STATE.you.id===id) return 'Vy';
      const o = STATE.others.find(x=>x.id===id);
      return o ? o.name : '';
    }

    function isMyTurn(){ return STATE && STATE.turnPlayerId && STATE.turnPlayerId===myId(); }

    function onPlay(card){
      if (!isMyTurn()){ addLog('â³ NynÃ­ nejste na tahu.'); return; }

      // karty bez cÃ­le â€“ hraj rovnou
      const noTarget = [ 'WHISKEY','CIGAR','SHOOTOUT','SPRAY','W_SAWED','W_DOUBLE','W_COLT','W_TOMMY','W_WINCH','W_SPRING','VEST' ];
      if (noTarget.includes(card.type)){
        addLog(`â–¶ï¸ Hraji ${META[card.type]?.name||card.type}.`);
        send({ type:'play', cardId: card.id });
        return;
      }

      // se cÃ­lem
      selectedCard = card;
      addLog(`ğŸ¯ Vyberte cÃ­l pro ${META[card.type]?.name||card.type}.`);
      highlightTargets();
    }

    function highlightTargets(){
      const nodes = Array.from(tableEl.querySelectorAll('.opponent'));
      nodes.forEach(n=>{ n.classList.remove('target'); n.onclick=null; });
      if (!selectedCard) return;
      for(const n of nodes){
        const pid = n.getAttribute('data-player-id');
        const op = STATE.others.find(o=>o.id===pid);
        if (!op || op.dead) continue;
        n.classList.add('target');
        n.onclick = ()=>{
          addLog(`â–¶ï¸ ${META[selectedCard.type]?.name||selectedCard.type} na ${op.name}.`);
          send({ type:'play', cardId: selectedCard.id, targetId: pid });
          selectedCard=null;
          nodes.forEach(x=>{ x.classList.remove('target'); x.onclick=null; });
        };
      }
    }

    endTurnBtn.onclick = ()=>{ if(!isMyTurn()){ addLog('â³ NynÃ­ nejste na tahu.'); return; } send({ type:'endTurn' }); };

    /* ---------- Reaction overlay ---------- */
    const ask=document.getElementById('ask');
    const askTitle=document.getElementById('askTitle');
    const askBody=document.getElementById('askBody');
    const askYes=document.getElementById('askYes');
    const askNo=document.getElementById('askNo');
    function showAsk(title, body, onYes, onNo){
      askTitle.textContent=title; askBody.innerHTML=body; ask.classList.add('show');
      askYes.onclick=onYes; askNo.onclick=onNo;
    }
    function hideAsk(){ ask.classList.remove('show'); askYes.onclick=null; askNo.onclick=null; }
  </script>
</body>
</html>
