<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Western Shots ‚Äì Realtime</title>
  <style>
    :root{--bg:#0e1116;--panel:#151a22;--muted:#8fa1b3;--text:#e7edf3;--accent:#5eead4;--accent-2:#7aa2ff;--card:#1c2430;--card-2:#232e3b;--shadow:0 10px 25px rgba(0,0,0,.35);--radius:18px}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 10% -10%,#1a2230 0%,var(--bg) 60%) fixed;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
    a{color:var(--accent)} #app{max-width:1200px;margin:0 auto;padding:16px 16px 24px}
    .btn{border:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg,#1f2836,#151b25);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow);transition:all .14s;font-weight:600}
    .btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.18)}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .btn-primary{background:linear-gradient(180deg,#2a3344,#18202e);border-color:#3b4a63}
    .grid{display:grid;gap:14px}
    .panel{background:linear-gradient(180deg,var(--panel),#0f141b);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .input{background:#0f141b;border:1px solid #2a3b52;border-radius:12px;padding:10px 12px;color:var(--text)}
    .muted{color:var(--muted)} .title{font-weight:800}
    .table{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    .opponent{background:linear-gradient(180deg,var(--panel),#10151c);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);padding:12px;display:flex;flex-direction:column;gap:10px;position:relative;box-shadow:var(--shadow);min-height:132px}
    .who{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .role-pill{font-size:12px;padding:4px 8px;border-radius:999px;background:#1f2937;color:#b7c5d8;border:1px solid rgba(255,255,255,.06)}
    .role-pill.revealed{background:#253044;color:#cfe3ff}
    .hearts{display:flex;gap:2px} .heart{font-size:16px;filter:drop-shadow(0 2px 6px rgba(0,0,0,.35))}
    .cards{font-size:13px;color:var(--muted)}
    .dead .overlay{position:absolute;inset:0;border-radius:var(--radius);background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;font-weight:800;color:#ffb4b4;font-size:22px;letter-spacing:1px}
    .center{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .hand{display:flex;flex-wrap:wrap;gap:10px;min-height:90px}
    .card{width:122px;min-height:82px;background:linear-gradient(180deg,var(--card-2),var(--card));border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:8px;display:flex;flex-direction:column;gap:6px;cursor:pointer;position:relative;box-shadow:var(--shadow);transition:transform .12s,border-color .12s}
    .card .ct{font-size:12px;text-transform:uppercase;letter-spacing:.6px;color:#c6d7ee;opacity:.9}
    .card .emoji{font-size:20px}
    .card .text{font-size:12px;color:#b8c5d7}
    .card:hover{transform:translateY(-2px);border-color:#7aa2ff77}
    .card.sel{outline:2px solid var(--accent-2);transform:translateY(-2px)}
    .target{outline:2px dashed #9dd1ff;border-radius:12px}
    .log{padding:12px;max-height:240px;overflow:auto}
    .hud{font-size:12px;color:#9fb4cc}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:40;padding:20px}
    .overlay.show{display:flex}
    .ask-box{background:linear-gradient(180deg,#17202c,#0e141c);border:1px solid #2a3b52;border-radius:16px;padding:16px;max-width:520px;width:100%;box-shadow:var(--shadow)}
    @media (max-width:930px){.table{grid-template-columns:1fr}.center{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div id="app" class="grid">
    <!-- LOBBY -->
    <section class="panel" id="lobbyPanel">
      <div class="title">üîó Lobby</div>
      <div class="row" style="margin-top:8px">
        <input id="name" class="input" placeholder="Va≈°e jm√©no" />
        <button id="createBtn" class="btn btn-primary">Vytvo≈ôit lobby</button>
        <input id="joinId" class="input" placeholder="K√≥d lobby (nap≈ô. ABCD)" style="width:140px" />
        <button id="joinBtn" class="btn">P≈ôipojit</button>
      </div>
      <div id="lobbyInfo" class="muted" style="margin-top:10px"></div>
      <div id="players" style="margin-top:8px"></div>
      <div class="row" style="margin-top:8px">
        <button id="readyBtn" class="btn">Jsem p≈ôipraven</button>
        <button id="startBtn" class="btn btn-primary" disabled>Start hry (host)</button>
      </div>
    </section>

    <!-- BOARD -->
    <section class="panel" id="boardPanel" style="display:none">
      <div class="row" style="justify-content:space-between">
        <div>
          <b>ü§† Western Shots</b> <span class="muted" id="roomTag"></span>
          <div class="hud" id="hud"></div>
        </div>
        <div class="row">
          <button id="endTurn" class="btn">‚è≠Ô∏è Konec tahu</button>
          <button id="backLobby" class="btn">‚Üê Lobby</button>
        </div>
      </div>

      <div class="center" style="margin-top:10px">
        <div class="panel">
          <div><b>Na tahu:</b> <span id="turnName">‚Äî</span></div>
          <div class="row" style="margin-top:8px">
            <div>Bal√≠ƒçek: <b id="deckCount">0</b></div>
            <div>Odhaz.: <b id="discardCount">0</b></div>
          </div>
          <div class="log" id="log"></div>
        </div>

        <div class="panel">
          <div class="title">St≈Øl</div>
          <div class="table" id="table"></div>
        </div>
      </div>

      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <div><b>üíº Va≈°e ruka</b></div>
          <div class="row muted">≈Ωivoty: <span id="meHearts" class="hearts" style="margin-left:6px"></span></div>
        </div>
        <div id="hand" class="hand"></div>
      </div>
    </section>
  </div>

  <!-- REACTION MODAL -->
  <div class="overlay" id="ask">
    <div class="ask-box">
      <h3 id="askTitle" style="margin:0 0 8px">Reakce</h3>
      <p id="askBody" class="muted" style="margin:0 0 10px"></p>
      <div class="row">
        <button id="askYes" class="btn btn-primary">üõ°Ô∏è √öhyb</button>
        <button id="askNo" class="btn">Utr≈æit z√°sah</button>
      </div>
    </div>
  </div>

  <script>
    /* ---------- WS ---------- */
    const ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host);
    const send = (obj) => { if(ws.readyState!==1){ addLog('‚ùó Spojen√≠ nen√≠ p≈ôipraveno.'); return false; } ws.send(JSON.stringify(obj)); return true; };

    ws.addEventListener('message', (ev) => {
      const msg = JSON.parse(ev.data);
      if (msg.type === 'lobby') {
        if (msg.youId) window.__myId = msg.youId;
        updateLobby(msg.lobby);
      }
      if (msg.type === 'info') addLog(msg.message);
      if (msg.type === 'error') addLog('‚ùó ' + msg.message);
      if (msg.type === 'state') applyState(msg.state);
    });

    /* ---------- LOBBY UI ---------- */
    const lobbyPanel = document.getElementById('lobbyPanel');
    const boardPanel = document.getElementById('boardPanel');
    const nameInp = document.getElementById('name');
    const createBtn = document.getElementById('createBtn');
    const joinIdInp = document.getElementById('joinId');
    const joinBtn = document.getElementById('joinBtn');
    const lobbyInfo = document.getElementById('lobbyInfo');
    const playersDiv = document.getElementById('players');
    const readyBtn = document.getElementById('readyBtn');
    const startBtn = document.getElementById('startBtn');
    const roomTag = document.getElementById('roomTag');

    createBtn.onclick = () => send({ type:'create', name: nameInp.value });
    joinBtn.onclick   = () => send({ type:'join', lobbyId: joinIdInp.value, name: nameInp.value });
    readyBtn.onclick  = () => send({ type:'ready', ready: true });
    startBtn.onclick  = () => send({ type:'start' });

    function updateLobby(lobby){
      window.__lobby = lobby;
      lobbyInfo.textContent = lobby ? `K√≥d lobby: ${lobby.lobbyId}  ‚Ä¢  Host: ${short(lobby.hostId)}` : '';
      playersDiv.innerHTML = lobby.players.map(p => `‚Ä¢ ${p.name} ${p.id===lobby.hostId?'(host)':''}`).join('<br/>');

      const iAmHost = (myId() && lobby && myId() === lobby.hostId);
      startBtn.disabled = !(iAmHost && lobby.players.length >= 2);

      if (lobby.started) {
        // p≈ôepnout do hern√≠ obrazovky; server stejnƒõ po≈°le "state"
        lobbyPanel.style.display = 'none';
        boardPanel.style.display = 'block';
        roomTag.textContent = `Lobby ${lobby.lobbyId}`;
      }
    }

    function myId(){ return window.__myId || null; }
    function short(x){ return x ? x.slice(0,4)+'‚Ä¶' : ''; }

    /* ---------- BOARD UI ---------- */
    const logEl = document.getElementById('log');
    const handEl = document.getElementById('hand');
    const tableEl = document.getElementById('table');
    const meHearts = document.getElementById('meHearts');
    const deckCountEl = document.getElementById('deckCount');
    const discardCountEl = document.getElementById('discardCount');
    const turnNameEl = document.getElementById('turnName');
    const endTurnBtn = document.getElementById('endTurn');
    const backLobbyBtn = document.getElementById('backLobby');
    const hud = document.getElementById('hud');

    backLobbyBtn.onclick = () => { boardPanel.style.display='none'; lobbyPanel.style.display='block'; };

    let STATE = null;       // personalized view from server
    let selectedCard = null;

    function addLog(msg){ const p=document.createElement('div'); p.textContent = msg; logEl.appendChild(p); logEl.scrollTop = logEl.scrollHeight; }

    const META = {
      SHOT:{emoji:'üî´',name:'V√Ωst≈ôel',desc:'Zra≈à c√≠l za 1. C√≠l m≈Ø≈æe zahr√°t üõ°Ô∏è √öhyb.'},
      DODGE:{emoji:'üõ°Ô∏è',name:'√öhyb',desc:'Reakce na V√Ωst≈ôel. Zru≈°√≠ z√°sah.'},
      BEER:{emoji:'üç∫',name:'Pivo',desc:'Vyl√©ƒç√≠ 1 ≈æivot (max. do plna).'},
      DRAW2:{emoji:'‚ûï2',name:'L√≠zni 2',desc:'Vezmi si 2 karty.'},
      DRAW3:{emoji:'‚ûï3',name:'L√≠zni 3',desc:'Vezmi si 3 karty.'}
    };

    function applyState(s){
      STATE = s;
      if (!window.__myId && s.you) window.__myId = s.you.id;

      deckCountEl.textContent = s.deckCount;
      discardCountEl.textContent = s.discardCount;
      turnNameEl.textContent = findName(s.turnPlayerId) || '‚Äî';

      hud.textContent = `Moje ID: ${short(myId()||'')} ‚Ä¢ Na tahu: ${findName(s.turnPlayerId)||'‚Äî'} ${isMyTurn()?'(J√Å)':''}`;

      // me hearts
      meHearts.innerHTML = '';
      for (let i=0;i<s.you.maxHp;i++){
        const span = document.createElement('span');
        span.className='heart';
        span.textContent = i<s.you.hp ? '‚ù§Ô∏è' : 'ü§ç';
        meHearts.appendChild(span);
      }

      // hand
      handEl.innerHTML = '';
      (s.you.hand||[]).forEach(card=>{
        const meta = META[card.type];
        const div = document.createElement('div');
        div.className='card';
        div.setAttribute('data-card-id', card.id);
        div.innerHTML = `<div class="ct">${meta.name}</div><div class="emoji">${meta.emoji}</div><div class="text">${meta.desc}</div>`;
        div.onclick = () => onPlay(card);
        handEl.appendChild(div);
      });

      // table
      renderOpponents(true);

      // reakce
      if (s.pending && s.pending.type==='SHOT' && s.pending.askYouToDodge){
        showAsk('√öhyb?', 'Byli jste terƒçem üî´ V√Ωst≈ôelu. Zahr√°t üõ°Ô∏è √öhyb?', ()=>{
          send({ type:'reaction', choice:'DODGE' }); hideAsk();
        }, ()=>{
          send({ type:'reaction', choice:'TAKE_HIT' }); hideAsk();
        });
      } else {
        hideAsk();
      }

      endTurnBtn.disabled = !isMyTurn() || !!s.pending;
    }

    function renderOpponents(resetTargets=false){
      tableEl.innerHTML = '';
      (STATE?.others||[]).forEach(op=>{
        const wrap = document.createElement('div');
        wrap.className = 'opponent' + (op.dead?' dead':'');
        wrap.setAttribute('data-player-id', op.id);
        wrap.innerHTML = `
          <div class="who">
            <div>${op.name}</div>
            <div class="role-pill ${op.roleRevealed?'revealed':''}">${op.roleRevealed ? (op.role || '‚Äî') : 'Nezn√°m√°'}</div>
          </div>
          <div class="hearts">${'‚ù§Ô∏è'.repeat(op.hp)}${'ü§ç'.repeat(Math.max(0, op.maxHp-op.hp))}</div>
          <div class="cards">Karty v ruce: ${op.handCount}</div>
        `;
        tableEl.appendChild(wrap);
      });

      if (resetTargets) {
        // po ka≈æd√©m stavu zru≈° zv√Ωraznƒõn√≠ (ƒçek√°me na nov√© kliknut√≠)
        Array.from(tableEl.querySelectorAll('.opponent')).forEach(n => { n.classList.remove('target'); n.onclick = null; });
        selectedCard = null;
      }
    }

    function findName(id){
      if (!STATE) return '';
      if (STATE.you && STATE.you.id===id) return 'Vy';
      const o = STATE.others.find(x=>x.id===id);
      return o ? o.name : '';
    }

    function isMyTurn(){ return STATE && STATE.turnPlayerId && STATE.turnPlayerId === myId(); }

    function onPlay(card){
      if (!isMyTurn()){ addLog('‚è≥ Nyn√≠ nejste na tahu.'); return; }

      if (card.type==='BEER' || card.type==='DRAW2' || card.type==='DRAW3'){
        addLog(`‚ñ∂Ô∏è Hraji ${META[card.type].name}.`);
        send({ type:'play', cardId: card.id });
        return;
      }

      if (card.type==='SHOT'){
        selectedCard = card;
        addLog('üéØ Vyberte c√≠l pro üî´ V√Ωst≈ôel.');
        highlightShotTargets();
      }
    }

    function highlightShotTargets(){
      const nodes = Array.from(tableEl.querySelectorAll('.opponent'));
      nodes.forEach(n => { n.classList.remove('target'); n.onclick = null; });
      if (!selectedCard || selectedCard.type!=='SHOT') return;
      for (const n of nodes){
        const pid = n.getAttribute('data-player-id');
        const op = STATE.others.find(o=>o.id===pid);
        if (!op || op.dead) continue;
        n.classList.add('target');
        n.onclick = () => {
          addLog(`‚ñ∂Ô∏è V√Ωst≈ôel na ${op.name}.`);
          send({ type:'play', cardId: selectedCard.id, targetId: pid });
          selectedCard = null;
          nodes.forEach(x => { x.classList.remove('target'); x.onclick = null; });
        };
      }
    }

    endTurnBtn.onclick = () => {
      if (!isMyTurn()){ addLog('‚è≥ Nyn√≠ nejste na tahu.'); return; }
      send({ type:'endTurn' });
    };

    /* ---------- reaction overlay ---------- */
    const ask = document.getElementById('ask');
    const askTitle = document.getElementById('askTitle');
    const askBody = document.getElementById('askBody');
    const askYes = document.getElementById('askYes');
    const askNo = document.getElementById('askNo');

    function showAsk(title, body, onYes, onNo){
      askTitle.textContent = title;
      askBody.innerHTML = body;
      ask.classList.add('show');
      askYes.onclick = onYes;
      askNo.onclick = onNo;
    }
    function hideAsk(){ ask.classList.remove('show'); askYes.onclick = null; askNo.onclick = null; }
  </script>
</body>
</html>
