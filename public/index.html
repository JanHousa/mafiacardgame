<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mafia Stand-off ‚Äì Realtime</title>
  <style>
    :root{
  --bg:#0e1116;--panel:#0f141c;--glass:#0d1320cc;--muted:#93a4b8;--text:#ecf2f8;
  --accent:#5eead4;--accent-2:#7aa2ff;--warn:#ff7b7b;--ok:#7bffbd;
  --stroke:#2a3b52;--shadow:0 20px 60px rgba(0,0,0,.45);--radius:20px
}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 10% -10%,#1a2230 0%,var(--bg) 60%) fixed;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
    a{color:var(--accent)} #app{max-width:1200px;margin:0 auto;padding:16px 16px 24px}
    .btn{border:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg,#1f2836,#151b25);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow);transition:all .14s;font-weight:600}
    .btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.18)}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .btn-primary{background:linear-gradient(180deg,#2a3344,#18202e);border-color:#3b4a63}
    .grid{display:grid;gap:14px}
    .panel{background:linear-gradient(180deg,var(--panel),#0f141b);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .input{background:#0f141b;border:1px solid #2a3b52;border-radius:12px;padding:10px 12px;color:var(--text)}
    .muted{color:var(--muted)} .title{font-weight:800}
    .table{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    .opponent{background:linear-gradient(180deg,var(--panel),#10151c);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);padding:12px;display:flex;flex-direction:column;gap:10px;position:relative;box-shadow:var(--shadow);min-height:132px}
    .who{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .role-pill{font-size:12px;padding:4px 8px;border-radius:999px;background:#1f2937;color:#b7c5d8;border:1px solid rgba(255,255,255,.06)}
    .role-pill.revealed{background:#253044;color:#cfe3ff}
    .status{display:flex;gap:6px;flex-wrap:wrap}
    .badge{font-size:12px;padding:3px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.08);color:#d3deea;background:#1e2633}
    .hearts{display:flex;gap:2px} .heart{font-size:16px;filter:drop-shadow(0 2px 6px rgba(0,0,0,.35))}
    .cards{font-size:13px;color:var(--muted)}
    .dead .overlay{position:absolute;inset:0;border-radius:var(--radius);background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;font-weight:800;color:#ffb4b4;font-size:22px;letter-spacing:1px}
    .center{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .hand{display:flex;flex-wrap:wrap;gap:10px;min-height:90px}
    .card{width:140px;min-height:86px;background:linear-gradient(180deg,var(--card-2),var(--card));border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:8px;display:flex;flex-direction:column;gap:6px;cursor:pointer;position:relative;box-shadow:var(--shadow);transition:transform .12s,border-color .12s}
    .card .ct{font-size:12px;text-transform:uppercase;letter-spacing:.6px;color:#c6d7ee;opacity:.9}
    .card .emoji{font-size:20px}
    .card .text{font-size:12px;color:#b8c5d7}
    .card:hover{transform:translateY(-2px);border-color:#7aa2ff77}
    .card.sel{outline:2px solid var(--accent-2);transform:translateY(-2px)}
    .target{outline:2px dashed #9dd1ff;border-radius:12px}
    .log{padding:12px;max-height:260px;overflow:auto}
    .hud{font-size:12px;color:#9fb4cc}
    /* ===== TIMER BAR ===== */
    .timerWrap{margin:8px 0;height:8px;background:#192233;border-radius:999px;overflow:hidden;border:1px solid #2b3b54}
    .timerBar{height:100%;width:100%;background:linear-gradient(90deg,#6ee7ff,#7aa2ff);transition:width .1s linear}
    .timerBar.red{background:linear-gradient(90deg,#ff8a8a,#ff5b5b)}
    .timerBar.gold{background:linear-gradient(90deg,#ffe082,#ffc13d)}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:40;padding:20px}
    .overlay.show{display:flex}
    .ask-box{background:linear-gradient(180deg,#17202c,#0e141c);border:1px solid #2a3b52;border-radius:16px;padding:16px;max-width:520px;width:100%;box-shadow:var(--shadow)}
    .ask-cta{display:flex;gap:10px;margin-top:10px}
    @media (max-width:930px){.table{grid-template-columns:1fr}.center{grid-template-columns:1fr}}
    /* === LOBBY ‚Äì nov√Ω vzhled === */
.lobby-hero{
  position:relative; overflow:hidden; border-radius:var(--radius);
  background:radial-gradient(1200px 800px at -10% -20%,#1b2536 0%,var(--panel) 60%);
  border:1px solid rgba(255,255,255,.06); box-shadow:var(--shadow); padding:0;
}
.lobby-art{
  position:absolute; inset:0; pointer-events:none; opacity:.18; mix-blend:screen;
}
.lobby-wrap{ display:grid; grid-template-columns: 1.1fr .9fr; gap:0; }
.lobby-left{ padding:26px 24px 20px 24px; display:flex; flex-direction:column; gap:14px; backdrop-filter: blur(10px); background: linear-gradient(180deg,transparent, transparent 60%, rgba(255,255,255,.02)); }
.lobby-right{ padding:22px; border-left:1px solid rgba(255,255,255,.06); background:linear-gradient(180deg, rgba(255,255,255,.02), transparent); }

.lobby-title{ display:flex; align-items:center; gap:10px; }
.logo-chip{
  width:42px;height:42px;border-radius:14px; display:grid; place-items:center;
  background:linear-gradient(180deg,#1f2836,#121824); border:1px solid rgba(255,255,255,.12);
  box-shadow:0 6px 16px rgba(0,0,0,.35);
}
.brand{ font-size:22px; font-weight:900; letter-spacing:.3px; }
.sub{ color:var(--muted); }

.lobby-actions{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.glass{
  background:linear-gradient(180deg,var(--glass), #0b111b77);
  border:1px solid rgba(255,255,255,.12); border-radius:18px; padding:14px;
}
.field{ display:flex; gap:10px; align-items:center; }
.input.big{ padding:14px 14px; border-radius:14px; font-weight:600; letter-spacing:.6px; text-transform:uppercase }
.btn.pill{ border-radius:999px; padding:12px 16px; font-weight:800 }

.lobby-code{
  display:inline-flex; align-items:center; gap:8px; font-weight:800; letter-spacing:1.4px;
  background:linear-gradient(180deg,#1b2331,#111824); padding:8px 12px; border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
}
.lobby-meta{ display:flex; gap:12px; flex-wrap:wrap; color:#a9bad0; font-size:13px }

.players-card .list{ margin-top:6px; line-height:1.6; }
.players-card .dot{ width:8px;height:8px;border-radius:50%; background:#7aa2ff; display:inline-block; margin-right:8px; }

.cta-row{ display:flex; gap:10px; flex-wrap:wrap; }
.btn.primary{ background:linear-gradient(180deg,#2a3344,#18202e); border-color:#3b4a63 }
.btn.secondary{ background:linear-gradient(180deg,#1f2836,#151b25) }
.btn.success{ background:linear-gradient(180deg,#1f3a2e,#10261f); border-color:#1b6b53 }

.hint{ color:#a7b9cf; font-size:12px; }
@media (max-width:980px){ .lobby-wrap{ grid-template-columns:1fr } .lobby-right{ border-left:none; border-top:1px solid rgba(255,255,255,.06) } }

/* drobnosti, a≈• to sedne na zbytek */
.input{ background:#0f141b; border:1px solid var(--stroke); color:var(--text) }
.btn{ border:1px solid rgba(255,255,255,.12) }
  </style>
</head>
<body>
  <div id="app" class="grid">
    <!-- LOBBY -->
    <section class="panel lobby-hero" id="lobbyPanel">
  <!-- ilustraƒçn√≠ ‚Äûobr√°zek‚Äú ‚Äì inline SVG (bez asset≈Ø) -->
  <svg class="lobby-art" viewBox="0 0 1200 400" preserveAspectRatio="none" aria-hidden="true">
    <defs>
      <linearGradient id="g1" x1="0" y1="0" x2="1" y2="0">
        <stop offset="0" stop-color="#7aa2ff"/>
        <stop offset="1" stop-color="#5eead4"/>
      </linearGradient>
    </defs>
    <!-- siluety ‚Äûmafie‚Äú -->
    <g fill="url(#g1)" opacity=".55">
      <path d="M90 360c0-55 40-100 90-100s90 45 90 100H90z"/>
      <rect x="150" y="160" width="60" height="100" rx="8"/>
      <circle cx="180" cy="140" r="28"/>
      <path d="M310 360c0-65 45-120 100-120s100 55 100 120H310z"/>
      <rect x="380" y="150" width="70" height="115" rx="10"/>
      <circle cx="415" cy="125" r="30"/>
      <path d="M690 360c0-75 55-140 120-140s120 65 120 140H690z"/>
      <rect x="770" y="140" width="80" height="120" rx="12"/>
      <circle cx="810" cy="112" r="34"/>
    </g>
    <!-- diagon√°ln√≠ linky -->
    <g stroke="url(#g1)" stroke-width="1" opacity=".25">
      <path d="M0 320 L1200 80"/>
      <path d="M0 360 L1200 120"/>
      <path d="M0 280 L1200 40"/>
    </g>
  </svg>

  <div class="lobby-wrap">
    <!-- LEFT: brand + create -->
    <div class="lobby-left">
      <div class="lobby-title">
        <div class="logo-chip">üï¥Ô∏è</div>
        <div>
          <div class="brand">Mafia Stand-off</div>
          <div class="sub">Real-time party card game ‚Ä¢ a≈æ 7 hr√°ƒç≈Ø</div>
        </div>
      </div>

      <div class="glass">
        <div class="sub" style="margin-bottom:8px">Vytvo≈ôit novou hru</div>
        <div class="field">
          <input id="name" class="input big" placeholder="Va≈°e jm√©no" />
          <button id="createBtn" class="btn pill primary">+ Vytvo≈ôit lobby</button>
        </div>
        <div class="lobby-meta" style="margin-top:10px">
          <span>‚ö° Peer-to-peer pocit ‚Ä¢ üßä WS realtime ‚Ä¢ üîí role skryt√©</span>
        </div>
      </div>

      <div class="glass players-card">
        <div class="sub" style="margin-bottom:6px">Hr√°ƒçi v lobby</div>
        <div id="players" class="list muted"><span class="hint">Zat√≠m nikdo‚Ä¶</span></div>
        <div class="cta-row" style="margin-top:10px">
          <button id="readyBtn" class="btn pill secondary">Jsem p≈ôipraven</button>
          <button id="startBtn" class="btn pill success" disabled>‚ñ∂ Start hry (host)</button>
        </div>
        <div id="lobbyInfo" class="hint" style="margin-top:8px"></div>
      </div>

      <div class="hint">Tip: sd√≠lej k√≥d lobby, a≈• se ostatn√≠ rychle p≈ôipoj√≠.</div>
    </div>

    <!-- RIGHT: join -->
    <div class="lobby-right">
      <div class="glass">
        <div class="sub" style="margin-bottom:8px">P≈ôipojit se ke h≈ôe</div>
        <div class="field">
          <input id="joinId" class="input big" placeholder="K√≥d lobby (nap≈ô. ABCD)" style="width:100%;max-width:260px" />
          <button id="joinBtn" class="btn pill">P≈ôipojit</button>
        </div>
        <div style="margin-top:12px">
          <span class="lobby-code">K√ìD: <span id="codeMirror">‚Äî</span></span>
        </div>
      </div>

      <div class="glass" style="margin-top:12px">
        <div class="sub">Jak to funguje?</div>
        <ul class="muted" style="margin:6px 0 0 18px; line-height:1.6">
          <li>Host klikne ‚ÄûVytvo≈ôit lobby‚Äú ‚Äì objev√≠ se k√≥d.</li>
          <li>Ostatn√≠ zadaj√≠ k√≥d a kliknou ‚ÄûP≈ôipojit‚Äú.</li>
          <li>Jakmile je v√°s min. 2, host m≈Ø≈æe ‚ÄûStart hry‚Äú.</li>
        </ul>
      </div>
    </div>
  </div>
</section>


    <!-- BOARD -->
    <section class="panel" id="boardPanel" style="display:none">
      <div class="row" style="justify-content:space-between">
        <div>
          <b>üï¥Ô∏è Mafia Stand-off</b> <span class="muted" id="roomTag"></span>
          <div class="hud" id="hud"></div>
          <div class="hud" id="continental"></div>
          <!-- Global event timer -->
          <div id="timerArea" style="display:none">
            <div class="hud" id="timerText"></div>
            <div class="timerWrap"><div id="timerBar" class="timerBar"></div></div>
          </div>
        </div>
        <div class="row">
          <button id="endTurn" class="btn">‚è≠Ô∏è Konec tahu</button>
          <button id="backLobby" class="btn">‚Üê Lobby</button>
        </div>
      </div>

      <div class="center" style="margin-top:10px">
        <div class="panel">
          <div><b>Na tahu:</b> <span id="turnName">‚Äî</span></div>
          <div class="row" style="margin-top:8px">
            <div>Bal√≠ƒçek: <b id="deckCount">0</b></div>
            <div>Odhaz.: <b id="discardCount">0</b></div>
          </div>
          <div class="log" id="log"></div>
        </div>

        <div class="panel">
          <div class="title">St≈Øl</div>
          <div class="table" id="table"></div>
        </div>
      </div>

      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <div><b>üíº Va≈°e ruka</b></div>
          <div class="row muted">≈Ωivoty: <span id="meHearts" class="hearts" style="margin-left:6px"></span></div>
        </div>
        <div id="hand" class="hand"></div>
      </div>
    </section>
  </div>

  <!-- REACTION MODALS -->
  <!-- Shot (classic dodge) -->
  <div class="overlay" id="askShot">
    <div class="ask-box">
      <h3 style="margin:0 0 8px">Reakce na V√Ωst≈ôel</h3>
      <p class="muted" style="margin:0 0 10px">Zahr√°t üõ°Ô∏è √öhyb nebo p≈ôijmout z√°sah?</p>
      <div class="timerWrap"><div id="shotTimer" class="timerBar red"></div></div>
      <div class="ask-cta">
        <button id="askShotYes" class="btn btn-primary">üõ°Ô∏è √öhyb</button>
        <button id="askShotNo" class="btn">Utr≈æit z√°sah</button>
      </div>
    </div>
  </div>

  <!-- Mass events (Shootout/Spray) -->
  <div class="overlay" id="askMass">
    <div class="ask-box">
      <h3 id="massTitle" style="margin:0 0 8px">Ud√°lost</h3>
      <p id="massBody" class="muted" style="margin:0 0 10px"></p>
      <div class="timerWrap"><div id="massTimer" class="timerBar gold"></div></div>
      <div class="ask-cta">
        <button id="massYes" class="btn btn-primary">Odhodit po≈æadovanou kartu</button>
        <button id="massNo" class="btn">Nechat b√Ωt</button>
      </div>
    </div>
  </div>

  <!-- Vendetta -->
  <div class="overlay" id="askVend">
    <div class="ask-box">
      <h3 style="margin:0 0 8px">Vendeta ‚Äì tvoje odpovƒõƒè</h3>
      <p class="muted" style="margin:0 0 10px">Odhoƒè üî´ V√Ωst≈ôel, nebo p≈ôijmi z√°sah.</p>
      <div class="timerWrap"><div id="vendTimer" class="timerBar red"></div></div>
      <div class="ask-cta">
        <button id="vendYes" class="btn btn-primary">Odhodit üî´</button>
        <button id="vendNo" class="btn">P≈ôijmout z√°sah</button>
      </div>
    </div>
  </div>

  <script>
    /* ---------- WS ---------- */
    const ws = new WebSocket((location.protocol==='https:'?'wss://':'ws://')+location.host);
    const send = (obj)=>{ if(ws.readyState!==1){ addLog('‚ùó Spojen√≠ nen√≠ p≈ôipraveno.'); return false; } ws.send(JSON.stringify(obj)); return true; };
    ws.addEventListener('message',(ev)=>{
      const msg = JSON.parse(ev.data);
      if (msg.type==='lobby'){ if(msg.youId) window.__myId = msg.youId; updateLobby(msg.lobby); }
      if (msg.type==='info'){ addLog(msg.message); }
      if (msg.type==='error'){ addLog('‚ùó '+msg.message); }
      if (msg.type==='state'){ applyState(msg.state); }
    });

    /* ---------- LOBBY UI ---------- */
    const lobbyPanel = document.getElementById('lobbyPanel');
    const boardPanel = document.getElementById('boardPanel');
    const nameInp = document.getElementById('name');
    const createBtn = document.getElementById('createBtn');
    const joinIdInp = document.getElementById('joinId');
    const joinBtn = document.getElementById('joinBtn');
    const lobbyInfo = document.getElementById('lobbyInfo');
    const playersDiv = document.getElementById('players');
    const readyBtn = document.getElementById('readyBtn');
    const startBtn = document.getElementById('startBtn');
    const roomTag = document.getElementById('roomTag');

    createBtn.onclick = ()=> send({ type:'create', name: nameInp.value });
    joinBtn.onclick   = ()=> send({ type:'join', lobbyId: joinIdInp.value, name: nameInp.value });
    readyBtn.onclick  = ()=> send({ type:'ready', ready: true });
    startBtn.onclick  = ()=> send({ type:'start' });

    function updateLobby(lobby){
  window.__lobby = lobby;
  const infoEl = document.getElementById('lobbyInfo');
  const codeMirror = document.getElementById('codeMirror');
  infoEl.textContent = lobby ? `K√≥d lobby: ${lobby.lobbyId}  ‚Ä¢  Host: ${short(lobby.hostId)} ‚Ä¢ Hr√°ƒç≈Ø: ${lobby.players.length}` : '';
  if (codeMirror) codeMirror.textContent = lobby ? lobby.lobbyId : '‚Äî';

  const playersDiv = document.getElementById('players');
  playersDiv.innerHTML = lobby.players.length
    ? lobby.players.map(p => `<span class="dot"></span>${p.name} ${p.id===lobby.hostId?'(host)':''}`).join('<br/>')
    : '<span class="hint">Zat√≠m nikdo‚Ä¶</span>';

  const startBtn = document.getElementById('startBtn');
  const iAmHost = (myId() && lobby && myId()===lobby.hostId);
  startBtn.disabled = !(iAmHost && lobby.players.length>=2);

  if (lobby.started){
    document.getElementById('lobbyPanel').style.display='none';
    document.getElementById('boardPanel').style.display='block';
    document.getElementById('roomTag').textContent = `Lobby ${lobby.lobbyId}`;
  }
}


    function myId(){ return window.__myId||null; }
    function short(x){ return x ? x.slice(0,4)+'‚Ä¶' : ''; }

    /* ---------- BOARD UI ---------- */
    const logEl=document.getElementById('log');
    const handEl=document.getElementById('hand');
    const tableEl=document.getElementById('table');
    const meHearts=document.getElementById('meHearts');
    const deckCountEl=document.getElementById('deckCount');
    const discardCountEl=document.getElementById('discardCount');
    const turnNameEl=document.getElementById('turnName');
    const endTurnBtn=document.getElementById('endTurn');
    const backLobbyBtn=document.getElementById('backLobby');
    const hud=document.getElementById('hud');
    const continental=document.getElementById('continental');

    const timerArea=document.getElementById('timerArea');
    const timerText=document.getElementById('timerText');
    const timerBar=document.getElementById('timerBar');

    backLobbyBtn.onclick = ()=>{ boardPanel.style.display='none'; lobbyPanel.style.display='block'; };

    let STATE=null, selectedCard=null, rafId=null;

    function addLog(msg){ const p=document.createElement('div'); p.textContent=msg; logEl.appendChild(p); logEl.scrollTop=logEl.scrollHeight; }

    const META={ SHOT:{emoji:'üî´',name:'V√Ωst≈ôel',desc:'St≈ôel na c√≠l do dost≈ôelu zbranƒõ. Obr√°nce m≈Ø≈æe üõ°Ô∏è.'},
      DODGE:{emoji:'üõ°Ô∏è',name:'√öhyb',desc:'Reakce na V√Ωst≈ôel.'},
      KNIFE:{emoji:'üî™',name:'N≈Ø≈æ',desc:'Zra≈à c√≠l ve vzd√°lenosti 1.'},
      MOLOTOV:{emoji:'üçæ',name:'Molotov',desc:'Zra≈à c√≠l ve vzd√°lenosti 1.'},
      SHOOTOUT:{emoji:'ü§úü§õ',name:'P≈ôest≈ôelka',desc:'Do 10s odhoƒè üî´, jinak -1.'},
      SPRAY:{emoji:'üå™Ô∏è',name:'Tommy Gun Spray',desc:'Do 10s odhoƒè üõ°Ô∏è, jinak -1.'},
      VENDETTA:{emoji:'üó°Ô∏è',name:'Vendeta',desc:'St≈ô√≠davƒõ odhazujte üî´ v 10s oknech.'},
      WHISKEY:{emoji:'ü•É',name:'Whiskey',desc:'+1 ≈æivot.'},
      CIGAR:{emoji:'üö¨',name:'Doutn√≠k',desc:'+1 ≈æivot.'},
      PRISON:{emoji:'üöî',name:'Vƒõzen√≠',desc:'C√≠l m≈Ø≈æe vynechat tah.'},
      EXTORTION:{emoji:'üí∞',name:'V√Ωpaln√©',desc:'Vem kartu nebo vybaven√≠.'},
      RAID:{emoji:'üî•',name:'Razie',desc:'Spal n√°hodnou kartu c√≠le.'},
      W_SAWED:{emoji:'üß©',name:'Sawed-off',desc:'Zbra≈à: dost≈ôel 2.'},
      W_DOUBLE:{emoji:'üß©',name:'Double-barrel',desc:'Zbra≈à: dost≈ôel 2.'},
      W_COLT:{emoji:'üß©',name:'Colt 1911',desc:'Zbra≈à: dost≈ôel 3.'},
      W_TOMMY:{emoji:'üß©',name:'Tommy Gun',desc:'Zbra≈à: dost≈ôel 3, neomezen√© üî´.'},
      W_WINCH:{emoji:'üß©',name:'Winchester',desc:'Zbra≈à: dost≈ôel 4.'},
      W_SPRING:{emoji:'üß©',name:'Springfield',desc:'Zbra≈à: dost≈ôel 5.'},
      VEST:{emoji:'ü¶∫',name:'Nepr≈Øst≈ôeln√° vesta',desc:'P≈ôi üî´ hoƒè kostkou; na ‚ù§Ô∏è ignoruje≈° z√°sah.'},
    };

    function applyState(s){
      STATE=s;
      if (!window.__myId && s.you) window.__myId = s.you.id;
      deckCountEl.textContent=s.deckCount; discardCountEl.textContent=s.discardCount;
      turnNameEl.textContent = findName(s.turnPlayerId)||'‚Äî';
      continental.textContent = s.roundNote ? `üÉè Kontinent√°l: ${s.roundNote}` : '';

      const myRole = s.you.role ? `‚Ä¢ Moje role: ${s.you.role}` : '';
      hud.textContent = `Na tahu: ${findName(s.turnPlayerId)||'‚Äî'} ${isMyTurn()?'(J√Å)':''} ${myRole}`;

      meHearts.innerHTML=''; for(let i=0;i<s.you.maxHp;i++){ const span=document.createElement('span'); span.className='heart'; span.textContent = i<s.you.hp ? '‚ù§' : 'ü§ç'; meHearts.appendChild(span); }

      handEl.innerHTML=''; (s.you.hand||[]).forEach(card=>{
        const m=META[card.type]||{name:card.type,emoji:'üÉè',desc:''};
        const div=document.createElement('div'); div.className='card'; div.setAttribute('data-card-id',card.id);
        div.innerHTML=`<div class="ct">${m.name}</div><div class="emoji">${m.emoji}</div><div class="text">${m.desc}</div>`;
        div.onclick=()=> onPlay(card); handEl.appendChild(div);
      });

      renderOpponents(true);
      endTurnBtn.disabled = !isMyTurn() || !!s.pending;

      // Event timers/overlays
      stopGlobalTimer();
      hideAllModals();
      if (s.pending){
        if (s.pending.type==='SHOT' && s.pending.askYouToDodge){
          showShotModal(s);
        }
        if (s.pending.type==='SHOOTOUT' || s.pending.type==='SPRAY'){
          const need = s.pending.need==='SHOT'?'üî´ V√Ωst≈ôel':'üõ°Ô∏è √öhyb';
          const txt = s.pending.type==='SHOOTOUT' ? 'P≈ôest≈ôelka' : 'Tommy Gun Spray';
          showGlobalTimer(`${txt}: do 10s ${need} ‚Äì jinak -1.`, s.pending.endsAt);
          if (s.pending.youNeedToReact){
            showMassModal(txt, `Reaguj: odhoƒè ${need}, nebo p≈ôijmi z√°sah.`, s.pending.endsAt, s.pending.need);
          }
        }
        if (s.pending.type==='VENDETTA'){
          showGlobalTimer(`Vendeta: br√°n√≠ se ${findName(s.pending.defenderId)} (10s).`, s.pending.endsAt);
          if (s.pending.youNeedToReact){
            showVendettaModal(s.pending.endsAt);
          }
        }
      }
    }

    function renderOpponents(resetTargets=false){
      tableEl.innerHTML='';
      (STATE?.others||[]).forEach(op=>{
        const wrap=document.createElement('div');
        wrap.className='opponent'+(op.dead?' dead':'');
        wrap.setAttribute('data-player-id',op.id);
        const roleHTML = `<div class="role-pill ${op.roleRevealed?'revealed':''}">${op.roleRevealed ? (op.role||'‚Äî') : 'Nezn√°m√°'}</div>`;
        const statusHTML = `
          <div class="status">
            ${op.inPrison?'<span class="badge">üöî Ve vƒõzen√≠</span>':''}
            ${op.weapon?`<span class="badge">üîß ${op.weapon.name}</span>`:''}
            ${op.vest?'<span class="badge">ü¶∫ Vesta</span>':''}
          </div>`;
        wrap.innerHTML = `
          <div class="who"><div>${op.name}</div>${roleHTML}</div>
          ${statusHTML}
          <div class="hearts">${'‚ù§'.repeat(op.hp)}${'ü§ç'.repeat(Math.max(0, op.maxHp-op.hp))}</div>
          <div class="cards">Karty v ruce: ${op.handCount}</div>
        `;
        tableEl.appendChild(wrap);
      });
      if (resetTargets){
        Array.from(tableEl.querySelectorAll('.opponent')).forEach(n=>{ n.classList.remove('target'); n.onclick=null; });
        selectedCard=null;
      }
    }

    function findName(id){ if(!STATE) return ''; if(STATE.you && STATE.you.id===id) return 'Vy'; const o=STATE.others.find(x=>x.id===id); return o?o.name:''; }
    function isMyTurn(){ return STATE && STATE.turnPlayerId && STATE.turnPlayerId===myId(); }

    function onPlay(card){
      if (!isMyTurn()){ addLog('‚è≥ Nyn√≠ nejste na tahu.'); return; }
      const noTarget = [ 'WHISKEY','CIGAR','SHOOTOUT','SPRAY','W_SAWED','W_DOUBLE','W_COLT','W_TOMMY','W_WINCH','W_SPRING','VEST' ];
      if (noTarget.includes(card.type)){ addLog(`‚ñ∂Ô∏è Hraji ${META[card.type]?.name||card.type}.`); send({ type:'play', cardId: card.id }); return; }
      selectedCard = card; addLog(`üéØ Vyberte c√≠l pro ${META[card.type]?.name||card.type}.`); highlightTargets();
    }
    function highlightTargets(){
      const nodes=Array.from(tableEl.querySelectorAll('.opponent')); nodes.forEach(n=>{ n.classList.remove('target'); n.onclick=null; });
      if (!selectedCard) return;
      for(const n of nodes){
        const pid=n.getAttribute('data-player-id');
        const op=STATE.others.find(o=>o.id===pid);
        if (!op || op.dead) continue;
        n.classList.add('target');
        n.onclick=()=>{ addLog(`‚ñ∂Ô∏è ${META[selectedCard.type]?.name||selectedCard.type} na ${op.name}.`); send({ type:'play', cardId: selectedCard.id, targetId: pid }); selectedCard=null; nodes.forEach(x=>{ x.classList.remove('target'); x.onclick=null; }); };
      }
    }
    endTurnBtn.onclick = ()=>{ if(!isMyTurn()){ addLog('‚è≥ Nyn√≠ nejste na tahu.'); return; } send({ type:'endTurn' }); };

    /* ---------- Timer helpers ---------- */
    function showGlobalTimer(text, endsAtMs){
      timerArea.style.display='block'; timerText.textContent=text; animateBar(timerBar, endsAtMs);
    }
    function stopGlobalTimer(){
      timerArea.style.display='none'; if (rafId) cancelAnimationFrame(rafId); rafId=null; timerBar.style.width='100%';
    }
    function animateBar(barEl, endsAt){
      function step(){
        const remaining = Math.max(0, endsAt - Date.now());
        const pct = remaining/10000; barEl.style.width = (pct*100)+'%';
        if (remaining>0) rafId = requestAnimationFrame(step);
        else barEl.style.width='0%';
      }
      step();
    }

    /* ---------- Modals ---------- */
    const askShot=document.getElementById('askShot');
    const shotYes=document.getElementById('askShotYes');
    const shotNo=document.getElementById('askShotNo');
    const shotTimer=document.getElementById('shotTimer');

    const askMass=document.getElementById('askMass');
    const massTitle=document.getElementById('massTitle');
    const massBody=document.getElementById('massBody');
    const massYes=document.getElementById('massYes');
    const massNo=document.getElementById('massNo');
    const massTimer=document.getElementById('massTimer');

    const askVend=document.getElementById('askVend');
    const vendYes=document.getElementById('vendYes');
    const vendNo=document.getElementById('vendNo');
    const vendTimer=document.getElementById('vendTimer');

    function hideAllModals(){ askShot.classList.remove('show'); askMass.classList.remove('show'); askVend.classList.remove('show'); }
    function showShotModal(s){
      askShot.classList.add('show'); animateBar(shotTimer, Date.now()+10000); // 10s ‚Äì serverovƒõ dr≈æ√≠ p≈ôesnƒõ, klient jen animuje
      shotYes.onclick=()=>{ send({ type:'reaction', choice:'DODGE' }); hideAllModals(); };
      shotNo.onclick =()=>{ send({ type:'reaction', choice:'TAKE_HIT' }); hideAllModals(); };
    }
    function showMassModal(title, body, endsAt, needType){
      askMass.classList.add('show'); massTitle.textContent=title; massBody.textContent=body; animateBar(massTimer, endsAt);
      massYes.onclick=()=>{ send({ type:'eventReaction', choice:'DISCARD' }); hideAllModals(); };
      massNo.onclick =()=>{ send({ type:'eventReaction', choice:'PASS' }); hideAllModals(); };
    }
    function showVendettaModal(endsAt){
      askVend.classList.add('show'); animateBar(vendTimer, endsAt);
      vendYes.onclick=()=>{ send({ type:'eventReaction', choice:'DISCARD' }); hideAllModals(); };
      vendNo .onclick=()=>{ send({ type:'eventReaction', choice:'PASS' }); hideAllModals(); };
    }
  </script>
</body>
</html>
